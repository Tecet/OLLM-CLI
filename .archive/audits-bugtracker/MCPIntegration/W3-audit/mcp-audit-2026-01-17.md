# MCP System Audit - January 17, 2026

## Summary

Comprehensive audit of the MCP (Model Context Protocol) system implementation covering 9 core files. The audit identified **2 critical bugs**, **6 high-priority bugs**, **5 medium-priority bugs**, and **4 low-priority issues**.

## Files Audited

1. `packages/core/src/mcp/mcpClient.ts` - Client implementation (520 lines)
2. `packages/core/src/mcp/mcpTransport.ts` - Transport layer (700 lines)
3. `packages/core/src/mcp/mcpSchemaConverter.ts` - Schema conversion (200 lines)
4. `packages/core/src/mcp/mcpToolWrapper.ts` - Tool wrapping (400 lines)
5. `packages/core/src/mcp/mcpHealthMonitor.ts` - Health monitoring (450 lines)
6. `packages/core/src/mcp/mcpOAuth.ts` - OAuth authentication (550 lines)
7. `packages/core/src/mcp/envSubstitution.ts` - Environment variable substitution (100 lines)
8. `packages/core/src/mcp/config.ts` - Configuration management (100 lines)
9. `packages/core/src/mcp/types.ts` - Type definitions (250 lines)

**Total Lines:** ~3,270 lines

---

## Critical Priority Bugs

### 1. Race Condition in OAuth Token Refresh (mcpOAuth.ts)
**Severity:** 游댮 CRITICAL  
**Location:** `packages/core/src/mcp/mcpOAuth.ts:88-102`  
**Issue:** Multiple concurrent requests can trigger simultaneous token refresh attempts, causing race conditions.

**Problem:**
```typescript
async getValidTokens(serverName: string): Promise<OAuthTokens | undefined> {
  // Check if token is expired
  if (now >= expiresWithBuffer) {
    if (tokens.refreshToken) {
      try {
        const refreshed = await this.refreshTokens(serverName, tokens.refreshToken);
        await this.storeTokens(serverName, refreshed);
        return refreshed;
      } catch (_error) {
        // ...
      }
    }
  }
}
```

**Impact:** Multiple refresh requests can be sent simultaneously, potentially invalidating tokens or causing authentication failures.

**Fix:** Add a refresh lock/promise cache to ensure only one refresh happens at a time per server.

---

### 2. No Timeout on OAuth Callback Server (mcpOAuth.ts)
**Severity:** 游댮 CRITICAL  
**Location:** `packages/core/src/mcp/mcpOAuth.ts:200-250`  
**Issue:** OAuth callback server has a 5-minute timeout, but the server itself doesn't properly clean up on timeout.

**Problem:**
```typescript
const timeout = setTimeout(() => {
  server.close();
  reject(new Error('OAuth callback timeout'));
}, 5 * 60 * 1000); // 5 minute timeout
```

**Impact:** Server may remain listening on port even after timeout, causing port conflicts on retry.

**Fix:** Ensure server is properly closed and all listeners are removed on timeout.

---

## High Priority Bugs

### 3. No Output Size Limit in StdioTransport (mcpTransport.ts)
**Severity:** 游 HIGH  
**Location:** `packages/core/src/mcp/mcpTransport.ts:100-110`  
**Issue:** No limit on stdout/stderr buffer size, can cause memory exhaustion.

**Problem:**
```typescript
this.process.stdout?.on('data', (data: Buffer) => {
  this.handleData(data);
});
```

**Impact:** Malicious or buggy MCP servers can exhaust memory by sending unlimited output.

**Fix:** Add buffer size limit (e.g., 10MB) and kill process if exceeded.

---

### 4. Weak Error Handling in SSE Transport (mcpTransport.ts)
**Severity:** 游 HIGH  
**Location:** `packages/core/src/mcp/mcpTransport.ts:300-350`  
**Issue:** SSE connection errors are logged but don't properly update connection state or reject pending requests.

**Problem:**
```typescript
.catch((error) => {
  if (error instanceof Error && error.name !== 'AbortError') {
    console.error('SSE connection error:', error);
    reject(error);
  }
});
```

**Impact:** Connection failures may leave client in inconsistent state with pending requests never resolved.

**Fix:** Ensure all pending requests are rejected and connection state is updated on error.

---

### 5. No Request Timeout in HTTP Transport (mcpTransport.ts)
**Severity:** 游 HIGH  
**Location:** `packages/core/src/mcp/mcpTransport.ts:550-600`  
**Issue:** HTTP requests have no timeout, can hang indefinitely.

**Problem:**
```typescript
const response = await fetch(this.url, {
  method: 'POST',
  headers,
  body: JSON.stringify(jsonRpcRequest),
});
```

**Impact:** Slow or unresponsive servers can cause indefinite hangs.

**Fix:** Add AbortController with timeout (e.g., 30 seconds).

---

### 6. Duplicate Tool Result Formatting Logic (mcpToolWrapper.ts)
**Severity:** 游 HIGH  
**Location:** `packages/core/src/mcp/mcpToolWrapper.ts:150-200, 350-400`  
**Issue:** Result formatting logic is duplicated in `formatResult()` and `formatMCPResult()`.

**Problem:** ~50 lines of identical code in two methods.

**Impact:** Maintenance burden, risk of inconsistent behavior if one is updated but not the other.

**Fix:** Extract to single shared method.

---

### 7. Health Monitor Restart Logic Race Condition (mcpHealthMonitor.ts)
**Severity:** 游 HIGH  
**Location:** `packages/core/src/mcp/mcpHealthMonitor.ts:350-400`  
**Issue:** Multiple health checks can trigger simultaneous restart attempts.

**Problem:**
```typescript
if (timeSinceLastRestart >= state.currentBackoffDelay) {
  state.restartAttempts++;
  state.lastRestartTime = now;
  // ...
  void this.attemptRestart(serverName, state.config);
}
```

**Impact:** Multiple concurrent restarts can cause resource leaks and connection issues.

**Fix:** Add restart lock to prevent concurrent restart attempts.

---

### 8. OAuth Token Storage Not Encrypted (mcpOAuth.ts)
**Severity:** 游 HIGH  
**Location:** `packages/core/src/mcp/mcpOAuth.ts:600-650`  
**Issue:** FileTokenStorage stores tokens in plain JSON without encryption.

**Problem:**
```typescript
await writeFile(this.tokensFile, JSON.stringify(allTokens, null, 2), 'utf-8');
```

**Impact:** OAuth tokens (including refresh tokens) are stored in plaintext, vulnerable to theft.

**Fix:** Encrypt tokens before writing to file, or enforce keytar usage.

---

## Medium Priority Bugs

### 9. No Validation of MCP Server Responses (mcpClient.ts)
**Severity:** 游리 MEDIUM  
**Location:** `packages/core/src/mcp/mcpClient.ts:250-300`  
**Issue:** Server responses are not validated against expected schema.

**Problem:**
```typescript
const tools = (response.result as any)?.tools || [];
```

**Impact:** Malformed responses can cause runtime errors or unexpected behavior.

**Fix:** Add response validation using Zod schemas.

---

### 10. Environment Variable Substitution Logs Warnings (envSubstitution.ts)
**Severity:** 游리 MEDIUM  
**Location:** `packages/core/src/mcp/envSubstitution.ts:20-30`  
**Issue:** Missing environment variables log warnings but continue with empty string.

**Problem:**
```typescript
if (envValue === undefined) {
  console.warn(`Environment variable '${varName}' not found, using empty string`);
  return '';
}
```

**Impact:** Silent failures can cause hard-to-debug configuration issues.

**Fix:** Add option to throw error on missing variables, or return undefined.

---

### 11. No Cleanup of Pending Requests on Disconnect (mcpTransport.ts)
**Severity:** 游리 MEDIUM  
**Location:** `packages/core/src/mcp/mcpTransport.ts:130-150`  
**Issue:** StdioTransport disconnect doesn't reject pending requests.

**Problem:**
```typescript
async disconnect(): Promise<void> {
  // ...
  proc.kill('SIGTERM');
  // No cleanup of pendingRequests
}
```

**Impact:** Pending requests may never resolve, causing memory leaks.

**Fix:** Reject all pending requests in disconnect().

---

### 12. Health Monitor Doesn't Handle Server Removal (mcpHealthMonitor.ts)
**Severity:** 游리 MEDIUM  
**Location:** `packages/core/src/mcp/mcpHealthMonitor.ts:200-250`  
**Issue:** If a server is removed from client, health monitor continues monitoring stale state.

**Problem:** No mechanism to detect and remove servers that no longer exist.

**Impact:** Memory leak from accumulating stale server states.

**Fix:** Periodically sync server states with client's server list.

---

### 13. OAuth Refresh Not Implemented (mcpOAuth.ts)
**Severity:** 游리 MEDIUM  
**Location:** `packages/core/src/mcp/mcpOAuth.ts:120-130`  
**Issue:** Token refresh method throws "not yet implemented" error.

**Problem:**
```typescript
async refreshTokens(_serverName: string, _refreshToken: string): Promise<OAuthTokens> {
  throw new Error('Token refresh not yet implemented - needs server config');
}
```

**Impact:** Tokens cannot be refreshed, requiring full re-authentication.

**Fix:** Implement token refresh using stored server config.

---

## Low Priority Issues

### 14. Weak Error Messages in Schema Converter (mcpSchemaConverter.ts)
**Severity:** 游릭 LOW  
**Location:** Throughout `mcpSchemaConverter.ts`  
**Issue:** No error messages or validation in schema conversion.

**Impact:** Silent failures or unexpected behavior with malformed schemas.

**Fix:** Add validation and descriptive error messages.

---

### 15. No Metrics/Telemetry in MCP Client (mcpClient.ts)
**Severity:** 游릭 LOW  
**Location:** Throughout `mcpClient.ts`  
**Issue:** No metrics for connection attempts, failures, tool calls, etc.

**Impact:** Difficult to monitor and debug MCP integration in production.

**Fix:** Add optional metrics/telemetry hooks.

---

### 16. Browser Opening May Fail Silently (mcpOAuth.ts)
**Severity:** 游릭 LOW  
**Location:** `packages/core/src/mcp/mcpOAuth.ts:450-470`  
**Issue:** Browser opening errors are logged but user may not see the URL.

**Problem:**
```typescript
exec(command, (error: Error | null) => {
  if (error) {
    console.error('Failed to open browser:', error);
    console.log('Please open this URL manually:', url);
  }
});
```

**Impact:** User may not know they need to manually open the URL.

**Fix:** Return URL to caller for display in UI.

---

### 17. No Connection Pooling for HTTP Transport (mcpTransport.ts)
**Severity:** 游릭 LOW  
**Location:** `packages/core/src/mcp/mcpTransport.ts:550-600`  
**Issue:** Each HTTP request creates a new connection.

**Impact:** Performance overhead for frequent requests.

**Fix:** Use HTTP keep-alive or connection pooling.

---

## Security Issues

### S1. Command Injection Risk in StdioTransport
**Severity:** 游댮 CRITICAL (if user-controlled)  
**Location:** `packages/core/src/mcp/mcpTransport.ts:70-80`  
**Issue:** Command and args are passed directly to spawn without validation.

**Current Code:**
```typescript
this.process = spawn(this.command, this.args, {
  stdio: ['pipe', 'pipe', 'pipe'],
  env: {
    ...process.env,
    ...this.env,
  },
});
```

**Risk:** If command or args come from untrusted sources, could execute arbitrary commands.

**Mitigation:** Commands should only come from trusted configuration files, not user input. Add validation if needed.

---

### S2. OAuth State Parameter Missing
**Severity:** 游 HIGH  
**Location:** `packages/core/src/mcp/mcpOAuth.ts:180-200`  
**Issue:** OAuth flow doesn't use state parameter for CSRF protection.

**Impact:** Vulnerable to CSRF attacks during OAuth flow.

**Fix:** Add state parameter generation and validation.

---

### S3. No Rate Limiting on Tool Calls
**Severity:** 游리 MEDIUM  
**Location:** `packages/core/src/mcp/mcpClient.ts:200-250`  
**Issue:** No rate limiting on tool calls to MCP servers.

**Impact:** Malicious or buggy code can overwhelm MCP servers.

**Fix:** Add rate limiting per server.

---

## Code Quality Issues

### Q1. Inconsistent Error Handling
**Location:** Throughout all files  
**Issue:** Mix of throwing errors, returning error objects, and logging errors.

**Fix:** Standardize error handling approach.

---

### Q2. Missing JSDoc for Public Methods
**Location:** Various files  
**Issue:** Some public methods lack JSDoc documentation.

**Fix:** Add comprehensive JSDoc to all public APIs.

---

### Q3. Type Safety Issues
**Location:** Multiple files use `any` type  
**Issue:** Excessive use of `any` type reduces type safety.

**Examples:**
- `mcpClient.ts:280` - `(response.result as any)?.tools`
- `mcpToolWrapper.ts:150` - `const resultObj = result as any`

**Fix:** Define proper types for MCP protocol messages.

---

## Performance Issues

### P1. No Connection Reuse in HTTP Transport
**Location:** `mcpTransport.ts:550-600`  
**Issue:** Each request creates new HTTP connection.

**Fix:** Implement connection pooling.

---

### P2. Synchronous JSON Parsing in Hot Path
**Location:** `mcpTransport.ts:200-250`  
**Issue:** JSON.parse() is called synchronously in data handlers.

**Fix:** Consider streaming JSON parser for large responses.

---

## Testing Gaps

1. **No tests for OAuth flow** - Complex authentication logic untested
2. **No tests for health monitor** - Restart logic and backoff untested
3. **No tests for transport error handling** - Connection failures untested
4. **No tests for concurrent operations** - Race conditions untested

---

## Recommendations

### Immediate (Critical/High Priority)
1. Fix OAuth token refresh race condition
2. Add output size limits to transports
3. Implement proper timeout handling
4. Fix health monitor restart race condition
5. Encrypt OAuth token storage

### Short Term (Medium Priority)
6. Implement OAuth token refresh
7. Add response validation
8. Clean up pending requests on disconnect
9. Sync health monitor with server list

### Long Term (Low Priority/Quality)
10. Add metrics and telemetry
11. Improve error messages
12. Add comprehensive test coverage
13. Standardize error handling
14. Improve type safety

---

## Summary Statistics

- **Total Issues:** 17 bugs + 3 security issues + 3 quality issues + 2 performance issues = 25 total
- **Critical:** 2 bugs + 1 security = 3 total
- **High:** 6 bugs + 1 security = 7 total
- **Medium:** 5 bugs + 1 security = 6 total
- **Low:** 4 bugs + 3 quality + 2 performance = 9 total

**Priority for Fixes:**
1. OAuth race condition (CRITICAL)
2. OAuth callback cleanup (CRITICAL)
3. Transport output limits (HIGH)
4. Request timeouts (HIGH)
5. Health monitor race condition (HIGH)
6. Token encryption (HIGH)

---

## Notes

- MCP system is complex with many moving parts
- OAuth implementation needs significant hardening
- Transport layer needs better error handling and resource management
- Health monitoring has good foundation but needs race condition fixes
- Overall architecture is sound, but implementation needs polish

**Estimated Fix Time:**
- Critical bugs: 8-12 hours
- High priority bugs: 12-16 hours
- Medium priority bugs: 8-12 hours
- **Total:** 28-40 hours

---

**Audit Date:** January 17, 2026  
**Auditor:** AI Assistant  
**Files Audited:** 9 files, ~3,270 lines of code
